BACKUP - Redundancia de dados com o proposito específico de restauraçao no caso de perda dos originais. 
- Importante considerar relação custo / risco.
Um backup eficiente é aquele que minimiza os impactos de uma perda de dados, provendo maneiras de restaurar dados e/ou serviços dentro de um tempo tolerável de indisponibilidade, e com desatualização razoável de informações. Se meu tempo de indisponibilidade é 2 horas, meu storage permite restaurar todos os dados em 2 horas? São questões a se considerar. É suficiente backup diário para compras de açoes na bolsas? Etc. 

Backups podem ser influenciados pela natureza dos dados, necessidades de negócio e infraestrutura disponível. A janela de backup (tem aplicaçoes que voce pode não fazer backup do momento, q voce pode precisar pro banco de dados, etc), tempos de retenção, periodicidade (diariamente, semanalmente vou precisar fazer backup?) e disponibilidade de capacidade em storage também devem ser considerados. 

Dispositivos de armazenamento mais comuns:
- Midia Otica (nunca muito utilizado)
- Fitas Magneticas (p medias e grandes empresas ainda sao bem utilizados, custos alto mas custo por gigaByte baixo)
- Discos Rígidos (aumento de confiabilidade e diminuiçao do custo por gigabyte)

Topologia do Backup 
- Descentralizado (varias maquinas e cada uma com espaço para fita magnetica e fazer backup nelas. modo antigo. muito trabalhoso.)
- Centralizado (voce tem um servidor de backup, tem clientes nas maquinas de onde quer extrair o backup)
- Backup em nuvem (mesma ideia do centralizado, mas voce pode estar armazenando seus dados em um servidor através da Internet.)

---

Melhores práticas de backup -
- Testar a conexão com novos clientes
- Simular e testar novos jobs de backup 
- Testar a restauraçao de novos jobs 
- Testar a restauraçao de aplicaçoes específicas
- Realizar testes de restauraçao periodicos. 

Mais importante que o backup é o restore, e pra garantir o restore é com teste. 

Política de backup corporativa -
Backup de bancos de dados devem ter retenção de 1 ano; mensagems de email 6 meses, etc. 

- Backups diferenciais serão realizados diariamente, se segunda à quinta-feira. Backups full serão executados semanalmente nas sextas-feiras. 
- Mídias obsoletas de backup serão incineradas ou picotados antes de serem descartados. 

- O sistema de backup é crítico por si e deve ter a maior disponibilidade possível (redundancia de energia, maior fonte de energia, replicação do banco de dados de backup, etc).

- Informar por escrito para o usuário ou gestor quais dados estao sendo protegidos por backup, ou não, o tempo, etc.; 

Automação:
- Operações de backup devem requerer a menor intervenção humana possível.
- Robos de fita devem requerer o minimo possivel de substituiçoes manuais de fitas (ou quase nenhuma substuiçao, comprar mais gaveta p/ gravar mais fitas possíveis)

////

Mitos do backup -
Retorno do investimento para o serviço de backup -
- Impossivel de ser mensurado 
- Ajuda a entender a resistencia de alguns gestores de investir em backup 
- Custo deve ser tratado como apolice de seguros; 

Backup vs sistemas de altia disponibilidade (ex: RAID):
- Diferentes funçoes 
- soluçoes de alta disponibilidade nao fornecem informaçao historica (ex: infos de 1 ano atrás)
- "Nada corrompe mais rapido que um espelho"

Custo de backup vs riscos -
- Nao existe sistemas de backup 100% seguro 
- Backup remoto ou cofre anti-chamas? 
- backups redundantes?
- backups de hora em hora? 

"É melhor usar scripts a ferramentas de backup":
- Nenhuma interoperabilidade 
- Mais difícil centralizar os backups (montagens smb, ftp ou nfs possume limitaçoes de perfomance)
- Alta complexidade 
- Perfomance ruim; 

//////////////////

Glossário -

- Retenção: (importante)
Período de tempo no qual os dados backupeados não podem ser sobrescritos ou apagados dos volumes de backup (A não ser que haja intervenção humana); O ideal é que o bacula seja automatizada, que o proprio bacula sobrescreva após um tempo; 

- Expiração:
Término da retençao de backup: tipicamente permite que a ferramenta de backup sobrescreva o volume expirado caso novos jobs de backup necessitem de espaço para serem gravados. O fato de ter expirado não significa que nao posso mais restaurar os dados antigos, é melhor gravar em fitas virgens caso tenha espaço, ao invés de reciclar aquele volume; 

- Job: 
Unidade de operação da ferramenta de backup. 
Evento único com duração finita. Basicamente podem ser jobs de backup (Escrita) ou restauração (leitura). 

Existem outros tipos de backups providos pelo bacula, a exemplo do job de cópia (é de storage para storage, não preciso acessar o servidor original) ou migração, desduplicação ou verificação. 

- Purge (é tipo eliminar o mal): 
Ato de permitir que informaçoes a respeito de um determinadao volume sejam sobrescritas (reciclagem). Também deleta indices do volume no banco de dados do Bacula. Geralmente é executado automaticamente quando o volume é expirado e outro job de backup precisa de espaço para gravação; Vai purgar o volume que contem informaçoes sobre o backup, e depois que purgar pode escrever informaçoes no volume/fita. 

- Volume: 
não é uma partição de hd. 
- Divisão Lógica na qual a ferramente de backup pode armazenar dados de diferentes servidores, na forma de uma sequencia de bytes;
- Para backups em disco, os volumes sao arquivos (e um disco pode conver vários volumes/arquivos)
- Para as fitas magnéticas, o volume se confunde com a propria fita (uma fita pode conter apenas um volume )

é tipo uma caixa onde a ferramenta de backup estará jogando os dados. no volume nao tenho sistema de arquivos, o disco tem um sistema de arquivos, mas o volume em si, os dados onde tao jogando os dados/sequencia de bytes, não tem. 

o bacula precisa de volume para gravar os dados de backup, o volume precisa ter tamanho q comporte os backups. posso ter jobs de backup que ocupem mais de uma fita ou mais de um volume de disco;  no caso de fita magnetica, so posso ter um volume por fita, entao o volume terá a mesma capacidade da sua fita; 

a reciclagem de volumes é uma transaçao atomica: ou eu descarto todos os dados nele, ou descarto nada; isso para fita é ruim. por isto, para backups de disco é deve-se priorizar ter varios volumes de backup no msm disco. 

é muito mais inteligente criar volumes de 25GB, 50GB e o bacula vai ter 20 volumes de backup de 50GB num disco de 1TB, então se o Bacula reciclar vai reciclar somente um volume de 50GB, vai perder somente uma parte dos dados; se eu tiver 1 disco so de 1TB, se eu tiver apenas um volume, na hora de eu reciclar vou perder todos os backups que tenho nesse disco de 1TB; 

- Pool: 
É um grupo de volumes que devem ter as mesmas propriedades (Ex: retenção) 

Todo job de backup é submetido para uma pool e só pode ser gravado em volumes que pertencem àquela pool 

Todos os volumes de uma pool devem utilizar volumes de um mesmo dispositivo de armazenamento. 

Dentro do banco de dados do Bacula teremos as pools de backup. 

- Catálogo: 
Banco de dados da ferramenta de backup que contém o índice de todos os arquivos backupeados. 

Toda ferramenta de backup tem um banco de dados, importante para saber onde tá cada dado, etc. É através do banco de dados q vc consegue listar os conteúdos de um backup, para restaurar. 

Permite listar os conteúdos de um backup e restaurar apenas alguns arquivos de determinado job;

Provê associação entre os jobs e os volumes que contem dados dos respectivos backups; 

Bacula é a única ferramenta de mercado multi-banco-de-dados;
Seu catálogo pode ser instalado em mysql, postgresql e sqlite; 

- FileSet:

Lista de arquivos ou diretórios que serão copiados pelos jobs que a utilizarem; 

Você pode incluir ou excluir diretórios do seu FileSet; 

Ex: incluir / (raiz) para um servidor Linux e excluir /tmp, /proc, etc. 

- Política de backup:
Documento corporativo formal que descreve os períodos de retenção, periodicidade e outros aspectos do serviço de backup.

Indispensável para o planejamento do backup, gerência de capacidade e previsão do crescimento dos backups; 

- GFS (grandfather, father, son) backup 
Esquema de rotação de backups mais utilizado no mundo;
Utiliza diferentes níveis de retenção, normalmente distribuídos entre backups diários, semanais e mensais; 

- On(/Off)-site backup: a cópia de segurança é armazenada no mesmo prédio dos dados originais (ou não = off-site); 

//////////////////

Níveis de Backup - 
Temos 3 tipos básicos de backup

- Full: 
Sempre copia todos os arquivos e diretórios incluídos no FileSet

Backups full são geralmente agendados para a execuçao as sextas ou sabados, à medida que geralmente existem menos usuarios utilizando os sistemas e janelas de backup maiores; 
 
Um backup full (como qualquer outro) pode ocupar um ou mais volumes. Bacula grava backups em multiplos volumes automaticamente; 

- Diferenciais/Incrementais - 

presumindo que tenha sido realizado um backup full numa sexta anterior de determinado servidor contendo os arquivos x,y e z.

Se na segunda o arquivo 'x' for modificado, no backup incremental ele vai copiar somente x. no backup diferencial, por enquanto, somente x. 
se na terça o arquivo 'y' foi modificado, no backup incremental ele irá copiar somente y. no backup diferencial, ele irá copiar 'x' e 'y'.
se na quarta o arquivo 'z' foi modificado, no backup incremental ele irá copiar somente 'z'. no backup diferencial, ele irá copiar 'x, y e z'

o diferencial copia tudo que foi diferente em relaçao ao ultimo backup full;  já o 'incremental' não, tudo q foi modificado ele incrementa ao backup; 

o 'backup diferencial' ocupa mais espaço de arquivo no armazenamento. já os backups incrementais ocupam menos espaço em armazenamento. 

agora, a restauraçao do backup diferencial é mais simples pois irá requerer no maximo o acesso a dois trabalhos realizados (ultimo backup full e ultimo diferencial). O backup incremental poderá requerer o acesso a até 5 trabalhos de backup anteriormente realizados (provavelmente em volumes diferentes). 

-> O backup diferencial contém apenas arquivos que foram modificados após o ultimo backup full;
O backup incremental copia apenas arquivos que tenham sido modificados após o término de qualquer job de backup, não importa o nível; 

/////////////////

Estratégia de Backup GFS - 
GFS é grand, father e son em ingles (avô, pai e filho). 

Hierarquia de backups -
Backups diarios: sons (filhos)
Backups semanais (fathers - pais)
Backups mensais (grandfathers - avôs)

Backups diários - reciclados a cada 7 dias (dentro desse período um backup full semanal ou mensal deve ser realizado).

Backups semanais - reciclados a cada 30 dias (neste período um backup full mensal deve ser realizado; full mensal fica por mais tempo).

Backups mensais - reciclados anualmente se utilizado um ano de retenção, salvo se a política de backup corporativa determine retenções totais diferentes. 

Efeitos do uso de GFS -
- Máxima retenção de backup com um mínimo consumo de armazenamento; 

- Sacrifica granularidade para a restauração ao longo do tempo, baseado no fato de que o usuário naturalmente deixa de necessitar de versões específicas de determinado arquivo ao longo do tempo; 

/////////////

O bacula - 
Suporta praticamente qualquer dispositivo de armazenamento (disco rígido, fita magnética, blue ray, etc) para armazenamento de backups; 

O bacula é um sofware de backup em rede; é 100% modular, ele tem o director (dir), q é o servidor de backup propriamente direto, quem comanda todas as operaçoes de backup; storage daemon (sd) que é onde vc armazena os dados de backup; file daemon (Fd) é o cliente do bacula isto é, de onde extrair os dados do backup, CATALOG (database) é o banco de dados do bacula; e consoles (Desktop & Web) posso ter consoles textos, graficos, web, etc. 

Regras implicitas: O Director deve ter ao menos instalado também um file daemon (cliente) na mesma máquina para realizar backup de suas configuraçoes, logs, etc.

O servidor do bacula, tbm precisamos ter backup de suas configuraçoes, do banco de dados do bacula, etc, pois o servidor do bacula tb ta passivel de desastres.  

Versões dos clientes devem sempre ser a mesma ou inferior ao Director. Em outras palavras: Jamais use um cliente com versão superior (mais novo) que o Director. 

O Bacula tem uma versão específica q possui plugins para facilitar o backup de aplicações específicas (Oracle, Postgresql, Microsoft Exchange, etc) e melhoria de perfomance (block level backup, NDMP, etc). 

///////////////////////

Bacula 9.4 Communiy Repositórios - 
Temos o bacula enterprise q possui interface gráfica, etc, e temos tbm o bacula community.

Temos o Driver Aligned, que é um plugin que fica no Storage Daemon, que é para o bacula gravar backups em disco, que podem ser duplicados através de um sistema de arquivos com deduplicação, como o XFS, etc. Na versão Community temos tbm o Driver S3 q é o plugin para armazenar dados na nuvem, no da Microsoft, etc... Temos a interface Baculum GUI também, que é uma interface gráfica q podemos fazer bastante coisa. Temos também o REST API, que se você quiser fazer alguma integração a um portal, etc, está mais fácil. 